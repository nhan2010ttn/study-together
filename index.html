<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Together Hub | Ultimate Master Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="text/javascript" id="MathJax-script" async
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --bg-deep: #050810;
            --bg-card: #0f172a;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --danger: #ef4444;
            --success: #22c55e;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #f1f5f9;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* T·ªëi ∆∞u h√≥a Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Video Grid tinh ch·ªânh */
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
            width: 100%;
            height: 100%;
            align-content: center;
            overflow-y: auto;
        }

        .video-container {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--bg-card);
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid transparent;
        }

        .video-container.speaking { border-color: var(--accent); box-shadow: 0 0 20px var(--accent-glow); }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror hi·ªáu ·ª©ng cho webcam */
        }

        /* Overlay khi t·∫Øt camera */
        .camera-off-overlay {
            position: absolute; inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            z-index: 10;
        }
        .is-cam-off .camera-off-overlay { display: flex; }

        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* B·∫£ng tr·∫Øng (Whiteboard) */
        #whiteboard-container {
            position: absolute;
            inset: 20px;
            background: white;
            border-radius: 24px;
            z-index: 200;
            display: none;
            flex-direction: column;
            overflow: hidden; /* Ch·ª©a scroll b√™n trong */
        }

        /* V√πng cu·ªôn cho b·∫£ng tr·∫Øng */
        #wb-scroll-area {
            flex: 1;
            overflow: auto;
            position: relative;
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: crosshair;
        }

        canvas#whiteboard {
            display: block;
            background: transparent;
            /* K√≠ch th∆∞·ªõc l·ªõn c·ªë ƒë·ªãnh ƒë·ªÉ cu·ªôn */
            width: 3000px;
            height: 2000px; 
        }

        /* Popup nh·∫≠p li·ªáu Math/Text */
        #math-input-popup {
            position: absolute;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border: 1px solid #e2e8f0;
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 300px;
            z-index: 300;
        }

        /* Hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh cho Sidebar */
        .sidebar-transition {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Tooltip & Controls */
        .control-btn {
            @apply p-4 rounded-2xl flex items-center justify-center transition-all duration-200 shadow-xl;
        }

        /* L·ªõp ph·ªß m√†n h√¨nh ch·ªù */
        #lobby-screen {
            background: radial-gradient(circle at top right, #0f172a, #050810);
        }

        .pomo-pulse {
            animation: pulse-ring 2s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(56, 189, 248, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
        }
    </style>
</head>
<body>

    <div id="lobby-screen" class="fixed inset-0 z-[2000] flex items-center justify-center">
        <div class="glass p-12 rounded-[3rem] w-full max-w-lg border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.8)]">
            <div class="flex flex-col items-center text-center mb-10">
                <div class="w-20 h-20 bg-gradient-to-tr from-sky-600 to-indigo-600 rounded-3xl flex items-center justify-center mb-6 shadow-2xl shadow-sky-500/20">
                    <i data-lucide="graduation-cap" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="text-4xl font-extrabold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Study Hub Master</h1>
                <p class="text-slate-400 mt-2 font-medium">H·ªá th·ªëng h·ªçc t·∫≠p P2P Mesh n√¢ng cao</p>
            </div>

            <div class="space-y-6">
                <div class="group">
                    <label class="block text-xs font-bold uppercase tracking-widest text-slate-500 mb-2 ml-1">T√™n c·ªßa b·∫°n</label>
                    <input id="user-name" type="text" placeholder="V√≠ d·ª•: Anh Dev" class="w-full bg-slate-900/50 border border-slate-700/50 p-4 rounded-2xl focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all font-semibold">
                </div>

                <div class="grid grid-cols-2 gap-4 pt-4">
                    <button onclick="handleSessionInit(true)" class="bg-sky-600 hover:bg-sky-500 py-4 rounded-2xl font-bold flex flex-col items-center gap-1 transition-all group">
                        <i data-lucide="plus-circle" class="w-6 h-6 group-hover:rotate-90 transition-transform"></i>
                        <span>T·∫°o ph√≤ng h·ªçc</span>
                    </button>
                    <div class="flex flex-col gap-2">
                        <input id="target-room-id" type="text" placeholder="ID Ph√≤ng..." class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl focus:outline-none text-center font-mono">
                        <button onclick="handleSessionInit(false)" class="bg-slate-700 hover:bg-slate-600 py-2 rounded-xl font-bold flex items-center justify-center gap-2">
                            <i data-lucide="log-in" class="w-4 h-4"></i> Tham gia
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 flex justify-center gap-6 text-slate-500">
                <div class="flex items-center gap-2 text-xs"><i data-lucide="shield-check" class="w-4 h-4 text-green-500"></i> P2P Encrypted</div>
                <div class="flex items-center gap-2 text-xs"><i data-lucide="zap" class="w-4 h-4 text-yellow-500"></i> Zero Server</div>
            </div>
        </div>
    </div>

    <header class="h-20 px-8 flex items-center justify-between glass z-50 border-b border-white/5">
        <div class="flex items-center gap-8">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-sky-500 rounded-xl shadow-lg shadow-sky-500/20">
                    <i data-lucide="box" class="w-5 h-5 text-white"></i>
                </div>
                <div class="flex flex-col">
                    <span class="font-bold text-lg tracking-tight leading-none">STUDY HUB</span>
                    <span id="display-room-id" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">PH√íNG: ---</span>
                </div>
            </div>

            <div id="pomo-wrapper" class="flex items-center bg-black/40 rounded-2xl p-1 pr-4 border border-white/5">
                <div id="pomo-timer-container" class="px-4 py-2 bg-slate-800 rounded-xl flex flex-col items-center min-w-[100px] transition-colors duration-500">
                    <span id="pomo-label" class="text-[8px] font-black tracking-widest uppercase text-slate-400">H·ªåC T·∫¨P</span>
                    <span id="pomo-time" class="text-2xl font-mono font-bold leading-none mt-1">25:00</span>
                </div>
                
                <div id="host-pomo-controls" class="hidden flex items-center gap-3 ml-4">
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <span class="text-[8px] text-slate-500 font-bold mb-1">H·ªåC</span>
                            <input type="number" id="cfg-study" value="25" class="w-8 bg-transparent text-sm font-bold text-sky-400 focus:outline-none text-center">
                        </div>
                        <div class="flex flex-col items-center">
                            <span class="text-[8px] text-slate-500 font-bold mb-1">NGH·ªà</span>
                            <input type="number" id="cfg-break" value="5" class="w-8 bg-transparent text-sm font-bold text-green-400 focus:outline-none text-center">
                        </div>
                    </div>
                    <button onclick="toggleTimer()" id="pomo-action-btn" class="w-10 h-10 rounded-xl bg-sky-600 flex items-center justify-center hover:bg-sky-500 shadow-lg shadow-sky-600/20 transition-all">
                        <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                    </button>
                    <button onclick="syncTimerToAll()" class="p-2 text-slate-500 hover:text-white" title="ƒê·ªìng b·ªô l·∫°i">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <div class="flex items-center bg-slate-800/40 px-4 py-2 rounded-2xl gap-3 border border-white/5">
                <button id="rain-toggle" onclick="toggleRainSound()" class="text-slate-400 hover:text-sky-400 transition-colors">
                    <i data-lucide="cloud-rain" class="w-5 h-5"></i>
                </button>
                <input type="range" id="rain-vol" min="0" max="1" step="0.05" value="0.3" class="w-16 accent-sky-500 bg-slate-700 h-1 rounded-full appearance-none">
            </div>

            <button onclick="openWhiteboard()" class="p-3 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-400 rounded-xl border border-indigo-500/20" title="B·∫£ng tr·∫Øng">
                <i data-lucide="pencil" class="w-5 h-5"></i>
            </button>
            <button onclick="toggleSidebar('participants')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl relative">
                <i data-lucide="users" class="w-5 h-5"></i>
                <span id="user-count" class="absolute -top-1 -right-1 bg-sky-500 text-white text-[8px] font-bold w-4 h-4 rounded-full flex items-center justify-center">1</span>
            </button>
            <button onclick="toggleSidebar('chat')" class="p-3 bg-slate-800 hover:bg-slate-700 rounded-xl relative">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span id="chat-notif" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <div class="flex-1 relative flex flex-col items-center justify-center">
            
            <div id="video-grid">
                <div id="local-video-container" class="video-container group border-sky-500/30">
                    <div class="camera-off-overlay">
                        <div id="local-avatar" class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center text-3xl font-extrabold shadow-2xl border-2 border-white/10">?</div>
                        <span class="mt-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Camera T·∫Øt</span>
                    </div>
                    <video id="local-video" autoplay muted playsinline></video>
                    <div class="absolute bottom-4 left-4 right-4 flex justify-between items-center pointer-events-none">
                        <div class="bg-black/60 backdrop-blur-md px-4 py-2 rounded-2xl flex items-center gap-2 border border-white/10">
                            <div id="local-mic-indicator" class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="text-xs font-bold">B·∫°n (T√¥i)</span>
                        </div>
                        <div class="flex gap-2">
                            <span id="local-tag-host" class="hidden bg-yellow-500 text-black text-[8px] font-black px-2 py-1 rounded-md uppercase">Ch·ªß ph√≤ng</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="whiteboard-container" class="shadow-2xl">
                <div class="p-4 bg-slate-900 flex justify-between items-center border-b border-white/5 rounded-t-2xl z-20 shadow-lg">
                    <div class="flex items-center gap-4">
                        <span class="font-bold flex items-center gap-2 text-indigo-400"><i data-lucide="pencil-line" class="w-4 h-4"></i> B·∫¢NG TR·∫ÆNG</span>
                        <div class="flex gap-2 bg-slate-800 p-1 rounded-lg">
                            <button onclick="setPenColor('#38bdf8')" class="w-6 h-6 rounded bg-sky-400"></button>
                            <button onclick="setPenColor('#ef4444')" class="w-6 h-6 rounded bg-red-500"></button>
                            <button onclick="setPenColor('#22c55e')" class="w-6 h-6 rounded bg-green-500"></button>
                            <button onclick="setPenColor('#000000')" class="w-6 h-6 rounded bg-black border border-white/20"></button>
                        </div>
                        <input type="range" id="pen-size" min="1" max="10" value="3" class="w-20 accent-indigo-500">
                        <button onclick="setTool('text')" id="tool-text-btn" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs font-bold flex items-center gap-1 transition">
                            <i data-lucide="type" class="w-4 h-4"></i> Text/Math
                        </button>
                        <button onclick="setTool('draw')" id="tool-draw-btn" class="px-3 py-1 bg-indigo-600 rounded text-xs font-bold flex items-center gap-1 transition">
                            <i data-lucide="edit-3" class="w-4 h-4"></i> V·∫Ω
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearWhiteboard()" class="px-4 py-1.5 bg-slate-800 hover:bg-slate-700 text-xs font-bold rounded-lg transition">X√ìA B·∫¢NG</button>
                        <button onclick="closeWhiteboard()" class="p-1.5 bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white rounded-lg transition"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
                
                <div id="wb-scroll-area">
                    <canvas id="whiteboard" width="3000" height="2000"></canvas>
                    
                    <div id="math-input-popup">
                        <div class="flex justify-between items-center border-b pb-2 mb-2">
                            <span class="text-xs font-bold text-slate-800">Nh·∫≠p VƒÉn B·∫£n / To√°n H·ªçc</span>
                            <button onclick="closeMathPopup()" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <textarea id="math-text-input" rows="3" class="w-full p-2 border rounded text-slate-800 text-sm focus:outline-none focus:border-indigo-500" placeholder="Nh·∫≠p text ho·∫∑c LaTeX (v√≠ d·ª•: \sqrt{x})"></textarea>
                        <div class="flex gap-2 justify-end">
                            <button onclick="insertMathToCanvas()" class="px-4 py-2 bg-indigo-600 text-white rounded text-xs font-bold hover:bg-indigo-500">CH√àN V√ÄO B·∫¢NG</button>
                        </div>
                        <div class="text-[10px] text-slate-500">G·ª£i √Ω: D√πng c√∫ ph√°p LaTeX cho to√°n h·ªçc. <br> VD: \frac{1}{2}, \pi, \sum</div>
                    </div>
                </div>
            </div>

            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 flex items-center gap-6 px-8 py-5 rounded-[2.5rem] glass border-white/10 shadow-[0_20px_50px_rgba(0,0,0,0.5)] z-[150]">
                <button onclick="handleMicToggle()" id="mic-btn" class="control-btn bg-slate-800 hover:bg-slate-700 border border-white/5 group">
                    <i data-lucide="mic" id="mic-icon" class="w-6 h-6 text-slate-300 group-hover:text-white"></i>
                </button>
                <button onclick="handleCamToggle()" id="cam-btn" class="control-btn bg-slate-800 hover:bg-slate-700 border border-white/5 group">
                    <i data-lucide="video" id="cam-icon" class="w-6 h-6 text-slate-300 group-hover:text-white"></i>
                </button>
                <button onclick="handleScreenShare()" id="screen-btn" class="control-btn bg-slate-800 hover:bg-slate-700 border border-white/5 group" title="Chia s·∫ª m√†n h√¨nh">
                    <i data-lucide="monitor-up" class="w-6 h-6 text-slate-300 group-hover:text-sky-400"></i>
                </button>
                <div class="w-[1px] h-8 bg-slate-700 mx-2"></div>
                <button onclick="handleLeaveRoom()" class="control-btn bg-red-500 hover:bg-red-600 shadow-lg shadow-red-500/20 group">
                    <i data-lucide="phone-off" class="w-6 h-6 text-white group-hover:scale-110 transition-transform"></i>
                </button>
            </div>
        </div>

        <aside id="main-sidebar" class="sidebar-transition w-[380px] glass border-l border-white/5 flex flex-col">
            
            <div class="flex border-b border-white/5">
                <button onclick="switchTab('chat')" id="tab-chat-btn" class="flex-1 p-4 text-xs font-black tracking-widest uppercase border-b-2 border-sky-500 bg-sky-500/5 text-sky-400">Th·∫£o lu·∫≠n</button>
                <button onclick="switchTab('todo')" id="tab-todo-btn" class="flex-1 p-4 text-xs font-black tracking-widest uppercase border-b-2 border-transparent text-slate-500">M·ª•c ti√™u</button>
                <button onclick="switchTab('users')" id="tab-users-btn" class="flex-1 p-4 text-xs font-black tracking-widest uppercase border-b-2 border-transparent text-slate-500">B·∫°n h·ªçc</button>
            </div>

            <div id="tab-chat" class="flex-1 flex flex-col p-6 overflow-hidden">
                <div id="chat-messages" class="flex-1 overflow-y-auto space-y-4 mb-4 pr-2">
                    <div class="bg-slate-800/50 p-4 rounded-2xl border border-white/5 italic text-slate-400 text-xs text-center">Ch√†o m·ª´ng b·∫°n ƒë·∫øn Study Hub Master.<br>G√µ <span class="text-sky-400 font-bold">/AI</span> ƒë·ªÉ tr√≤ chuy·ªán v·ªõi tr·ª£ l√Ω ·∫£o.</div>
                </div>
                <form id="chat-form" class="relative group">
                    <input id="chat-input" type="text" placeholder="G·ª≠i l·ªùi nh·∫Øn..." class="w-full bg-slate-800/50 border border-white/10 rounded-2xl px-5 py-4 pr-14 focus:outline-none focus:border-sky-500 transition-all font-medium text-sm">
                    <button type="submit" class="absolute right-2 top-2 p-2 bg-sky-600 rounded-xl hover:bg-sky-500 text-white transition-all">
                        <i data-lucide="send" class="w-5 h-5"></i>
                    </button>
                </form>
            </div>

            <div id="tab-todo" class="hidden flex-1 flex flex-col p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-slate-300">NHI·ªÜM V·ª§ NH√ìM</h3>
                    <span id="todo-stats" class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-500">0/0</span>
                </div>
                <div id="todo-list" class="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                    </div>
                <div class="flex gap-2">
                    <input id="todo-input" type="text" placeholder="Th√™m m·ª•c ti√™u m·ªõi..." class="flex-1 bg-slate-800/50 border border-white/10 rounded-xl px-4 py-2 text-sm focus:outline-none">
                    <button onclick="addNewTodo()" class="p-2 bg-indigo-600 rounded-xl hover:bg-indigo-500 transition-all"><i data-lucide="plus" class="w-5 h-5"></i></button>
                </div>
            </div>

            <div id="tab-users" class="hidden flex-1 flex flex-col p-6 overflow-hidden">
                <h3 class="font-bold text-slate-300 mb-6 flex items-center gap-2">
                    TH√ÄNH VI√äN TRONG PH√íNG
                    <span id="p-count-badge" class="bg-sky-500/20 text-sky-400 text-[10px] px-2 py-0.5 rounded-full">1</span>
                </h3>
                <div id="participant-list" class="space-y-4">
                    <div class="flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/5">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-sky-500 rounded-full flex items-center justify-center font-bold text-xs">B·∫†N</div>
                            <div class="flex flex-col">
                                <span class="text-sm font-bold" id="me-name-list">Ch∆∞a ƒë·∫∑t t√™n</span>
                                <span class="text-[10px] text-slate-500 italic">ƒêang online</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <i data-lucide="mic" class="w-3 h-3 text-green-500"></i>
                            <i data-lucide="video" class="w-3 h-3 text-green-500"></i>
                        </div>
                    </div>
                </div>
            </div>

        </aside>
    </main>

    <footer class="h-8 bg-black/80 flex items-center px-8 border-t border-white/5 justify-between">
        <div class="flex gap-6 text-[10px] text-slate-600 font-bold uppercase tracking-widest">
            <span class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> T·ªîNG TH·ªúI GIAN H·ªåC: <span id="total-study-time" class="text-sky-500">0P</span></span>
            <span class="flex items-center gap-1"><i data-lucide="activity" class="w-3 h-3 text-green-500"></i> P2P MESH STABLE</span>
        </div>
        <div class="text-[9px] text-slate-700 italic">Developed by Gemini Hub Engine &copy; 2024</div>
    </footer>

    <audio id="snd-rain" loop src="https://www.soundjay.com/nature/rain-01.mp3"></audio>
    <audio id="snd-alert" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        /**
         * GLOBAL STATE
         */
        let myPeer, myStream, myScreenStream, myId;
        let myUserName = "User_" + Math.floor(Math.random()*1000);
        let isHost = false;
        let activeTab = 'chat';
        
        const peerConnections = {}; // L∆∞u tr·ªØ c√°c cu·ªôc g·ªçi (MediaStream)
        const dataConnections = {}; // L∆∞u tr·ªØ c√°c k√™nh d·ªØ li·ªáu (DataChannel)
        const participants = {};    // Th√¥ng tin metadata v·ªÅ th√†nh vi√™n

        // Pomodoro State
        let timerSeconds = 25 * 60;
        let timerInterval = null;
        let currentMode = 'study'; // 'study' | 'break'
        let totalFocusMinutes = 0;

        // Whiteboard State
        const canvas = document.getElementById('whiteboard');
        const ctx = canvas.getContext('2d');
        const wbScrollArea = document.getElementById('wb-scroll-area');
        let isDrawing = false;
        let penColor = '#38bdf8';
        let penSize = 3;
        let currentTool = 'draw'; // 'draw' | 'text'
        let popupClickPos = {x: 0, y: 0};
        
        // Multiplayer Drawing Fix: L∆∞u v·ªã tr√≠ cu·ªëi c√πng c·ªßa t·ª´ng user
        const lastPositions = {}; 

        // To-do State
        let todos = [];

        // AI Bot State
        let aiIdleTimer = null;
        const AI_IDLE_TIMEOUT = 120000; // 2 ph√∫t kh√¥ng ai n√≥i g√¨ th√¨ bot h·ªèi

        /**
         * AI BOT LOGIC
         */
        class MiniBot {
            constructor() {
                this.name = "AI Assistant";
                this.greetings = ["Ch√†o b·∫°n! Ch√∫c m·ªôt bu·ªïi h·ªçc hi·ªáu qu·∫£ nh√©.", "Hi! C·∫ßn gi√∫p g√¨ c·ª© g·ªçi m√¨nh nha.", "Hello! S·∫µn s√†ng h·ªçc t·∫≠p ch∆∞a?"];
                this.idleMsgs = ["M·ªçi ng∆∞·ªùi ƒë√¢u h·∫øt r·ªìi nh·ªâ? Im ·∫Øng qu√° üòÖ", "ƒê·ª´ng qu√™n u·ªëng n∆∞·ªõc nha c√°c b·∫°n!", "H·ªçc m·ªát th√¨ nh·ªõ ngh·ªâ gi·∫£i lao x√≠u nh√©.", "C√≥ ai ƒëang g·∫∑p b√†i kh√≥ kh√¥ng?"];
                this.responses = {
                    "ch√†o": "Ch√†o b·∫°n! R·∫•t vui ƒë∆∞·ª£c g·∫∑p.",
                    "hello": "Hello! Ch√∫c b·∫°n ng√†y t·ªët l√†nh.",
                    "kh·ªèe kh√¥ng": "M√¨nh l√† AI n√™n l√∫c n√†o c≈©ng full nƒÉng l∆∞·ª£ng! C√≤n b·∫°n?",
                    "m·ªát": "C·ªë l√™n n√†o! Ngh·ªâ 5 ph√∫t r·ªìi chi·∫øn ti·∫øp.",
                    "bu·ªìn": "ƒê·ª´ng bu·ªìn, vi·ªác h·ªçc l√† t∆∞∆°ng lai m√†!",
                    "gi·ªù": () => `B√¢y gi·ªù l√† ${new Date().toLocaleTimeString()} r·ªìi ƒë√≥.`
                };
            }

            process(msg) {
                const lower = msg.toLowerCase();
                for (let key in this.responses) {
                    if (lower.includes(key)) {
                        const resp = this.responses[key];
                        return typeof resp === 'function' ? resp() : resp;
                    }
                }
                return "M√¨nh ch∆∞a hi·ªÉu √Ω b·∫°n l·∫Øm, nh∆∞ng m√¨nh lu√¥n ·ªü ƒë√¢y ƒë·ªÉ c·ªï v≈© b·∫°n!";
            }

            getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
        }
        const bot = new MiniBot();

        function resetAIIdleTimer() {
            if(aiIdleTimer) clearTimeout(aiIdleTimer);
            aiIdleTimer = setTimeout(() => {
                const msg = bot.getRandom(bot.idleMsgs);
                appendMessage(bot.name, msg, true);
            }, AI_IDLE_TIMEOUT);
        }

        /**
         * 1. H·ªÜ TH·ªêNG KH·ªûI T·∫†O (INIT)
         */
        async function handleSessionInit(asHost) {
            const inputName = document.getElementById('user-name').value.trim();
            if(!inputName) return alert("Vui l√≤ng nh·∫≠p t√™n!");
            
            myUserName = inputName;
            isHost = asHost;
            document.getElementById('me-name-list').innerText = myUserName;
            document.getElementById('local-avatar').innerText = myUserName.substring(0,2).toUpperCase();
            if(isHost) document.getElementById('local-tag-host').classList.remove('hidden');

            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('local-video').srcObject = myStream;
                
                const roomId = isHost ? generateId() : document.getElementById('target-room-id').value.trim();
                if(!roomId && !isHost) return alert("Vui l√≤ng nh·∫≠p ID ph√≤ng!");

                initPeer(isHost ? roomId : null);
            } catch (err) {
                console.error(err);
                alert("L·ªói camera/micro: " + err.message);
            }
        }

        function generateId() {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function initPeer(id) {
            myPeer = new Peer(id, {
                host: '0.peerjs.com',
                port: 443,
                secure: true,
            });

            myPeer.on('open', (id) => {
                myId = id;
                document.getElementById('display-room-id').innerText = `PH√íNG: ${id}`;
                document.getElementById('lobby-screen').style.display = 'none';
                if(isHost) {
                    document.getElementById('host-pomo-controls').classList.remove('hidden');
                    updateParticipant(myId, myUserName, true, true, true);
                } else {
                    connectToHost(document.getElementById('target-room-id').value.trim());
                }
                refreshIcons();
                resetAIIdleTimer(); // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c idle
            });

            myPeer.on('call', call => {
                call.answer(myStream);
                setupMediaConnection(call);
            });

            myPeer.on('connection', conn => {
                setupDataConnection(conn);
            });
            
            myPeer.on('error', err => {
                console.error("Peer Error:", err.type);
                if(err.type === 'peer-unavailable') alert("Ph√≤ng kh√¥ng t·ªìn t·∫°i!");
            });
        }

        /**
         * 2. X·ª¨ L√ù K·∫æT N·ªêI (NETWORKING)
         */
        function connectToHost(hostId) {
            const call = myPeer.call(hostId, myStream);
            setupMediaConnection(call);
            const conn = myPeer.connect(hostId);
            setupDataConnection(conn);
        }

        function setupMediaConnection(call) {
            const peerId = call.peer;
            peerConnections[peerId] = call;

            const video = document.createElement('video');
            const container = document.createElement('div');
            container.className = "video-container";
            container.id = `v-container-${peerId}`;
            container.innerHTML = `
                <div class="camera-off-overlay">
                    <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center text-3xl font-extrabold shadow-2xl border-2 border-white/10" id="avatar-${peerId}">?</div>
                    <span class="mt-4 text-xs font-bold text-slate-500 uppercase tracking-widest">Camera T·∫Øt</span>
                </div>
                <div class="absolute bottom-4 left-4 flex items-center gap-2 bg-black/60 backdrop-blur-md px-4 py-2 rounded-2xl border border-white/10 z-20">
                    <div id="mic-ind-${peerId}" class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-xs font-bold" id="name-${peerId}">ƒêang t·∫£i...</span>
                </div>
            `;
            container.appendChild(video);

            call.on('stream', remoteStream => {
                video.srcObject = remoteStream;
                video.autoplay = true;
                video.playsinline = true;
                document.getElementById('video-grid').appendChild(container);
            });

            call.on('close', () => {
                container.remove();
                delete peerConnections[peerId];
                removeParticipant(peerId);
            });
        }

        function setupDataConnection(conn) {
            const peerId = conn.peer;
            dataConnections[peerId] = conn;

            conn.on('open', () => {
                sendToPeer(peerId, {
                    type: 'identity',
                    name: myUserName,
                    mic: myStream.getAudioTracks()[0].enabled,
                    cam: myStream.getVideoTracks()[0].enabled
                });

                if(isHost) {
                    // Sync tr·∫°ng th√°i ph√≤ng, bao g·ªìm c·∫£ ·∫£nh b·∫£ng tr·∫Øng
                    sendToPeer(peerId, {
                        type: 'full-sync',
                        timer: timerSeconds,
                        mode: currentMode,
                        todos: todos,
                        participants: participants,
                        wbData: canvas.toDataURL() // G·ª≠i ·∫£nh b·∫£ng hi·ªán t·∫°i
                    });
                }
            });

            conn.on('data', data => handleIncomingData(peerId, data));
            
            conn.on('close', () => {
                delete dataConnections[peerId];
                removeParticipant(peerId);
            });
        }

        /**
         * 3. X·ª¨ L√ù D·ªÆ LI·ªÜU ƒê·∫æN (DATA PROTOCOL)
         */
        function handleIncomingData(peerId, data) {
            switch(data.type) {
                case 'identity':
                    updateParticipant(peerId, data.name, data.mic, data.cam);
                    break;
                case 'chat':
                    appendMessage(data.user, data.msg);
                    resetAIIdleTimer();
                    break;
                case 'pomo-sync':
                    timerSeconds = data.timer;
                    currentMode = data.mode;
                    updateTimerUI();
                    break;
                case 'full-sync':
                    timerSeconds = data.timer;
                    currentMode = data.mode;
                    todos = data.todos;
                    Object.assign(participants, data.participants);
                    renderParticipants();
                    renderTodos();
                    updateTimerUI();
                    if(data.wbData) {
                        const img = new Image();
                        img.onload = () => ctx.drawImage(img, 0, 0);
                        img.src = data.wbData;
                    }
                    break;
                case 'draw':
                    // Fix: Truy·ªÅn peerId ƒë·ªÉ v·∫Ω ƒë√∫ng n√©t ng∆∞·ªùi ƒë√≥
                    drawOnCanvas(data.x, data.y, data.color, data.size, data.isNewPath, peerId);
                    break;
                case 'draw-image':
                    const img = new Image();
                    img.onload = () => ctx.drawImage(img, data.x, data.y);
                    img.src = data.src;
                    break;
                case 'clear-wb':
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    break;
                case 'todo-update':
                    todos = data.todos;
                    renderTodos();
                    break;
                case 'mic-cam-status':
                    updateParticipantStatus(peerId, data.mic, data.cam);
                    break;
            }
        }

        function broadcast(payload) {
            Object.values(dataConnections).forEach(conn => conn.send(payload));
        }

        function sendToPeer(peerId, payload) {
            if(dataConnections[peerId]) dataConnections[peerId].send(payload);
        }

        /**
         * 4. QU·∫¢N L√ù TH√ÄNH VI√äN
         */
        function updateParticipant(id, name, mic, cam, local = false) {
            participants[id] = { name, mic, cam, local };
            renderParticipants();
            
            const nameLabel = document.getElementById(`name-${id}`);
            if(nameLabel) nameLabel.innerText = name;
            
            const avatarLabel = document.getElementById(`avatar-${id}`);
            if(avatarLabel) avatarLabel.innerText = name.substring(0,2).toUpperCase();

            updateParticipantStatus(id, mic, cam);
        }

        function updateParticipantStatus(id, mic, cam) {
            if(participants[id]) {
                participants[id].mic = mic;
                participants[id].cam = cam;
            }

            const micInd = document.getElementById(id === myId ? 'local-mic-indicator' : `mic-ind-${id}`);
            if(micInd) micInd.className = `w-2 h-2 rounded-full ${mic ? 'bg-green-500' : 'bg-red-500 animate-pulse'}`;

            const container = document.getElementById(id === myId ? 'local-video-container' : `v-container-${id}`);
            if(container) {
                if(!cam) container.classList.add('is-cam-off');
                else container.classList.remove('is-cam-off');
            }
            renderParticipants();
        }

        function removeParticipant(id) {
            delete participants[id];
            delete lastPositions[id]; // X√≥a v·ªã tr√≠ v·∫Ω c·ªßa user
            renderParticipants();
        }

        function renderParticipants() {
            const list = document.getElementById('participant-list');
            const pCount = Object.keys(participants).length;
            document.getElementById('user-count').innerText = pCount;
            document.getElementById('p-count-badge').innerText = pCount;
            
            list.innerHTML = '';
            Object.keys(participants).forEach(id => {
                const p = participants[id];
                const item = document.createElement('div');
                item.className = "flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/5";
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${id === myId ? 'bg-sky-500' : 'bg-slate-700'} rounded-full flex items-center justify-center font-bold text-xs uppercase">
                            ${p.name.substring(0,2)}
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold">${p.name} ${id === myId ? '(B·∫°n)' : ''}</span>
                            <span class="text-[10px] text-slate-500 italic">${id === myId ? 'ƒêang ƒëi·ªÅu khi·ªÉn' : 'ƒêang h·ªçc'}</span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <i data-lucide="mic${p.mic ? '' : '-off'}" class="w-3.5 h-3.5 ${p.mic ? 'text-green-500' : 'text-red-500'}"></i>
                        <i data-lucide="video${p.cam ? '' : '-off'}" class="w-3.5 h-3.5 ${p.cam ? 'text-green-500' : 'text-red-500'}"></i>
                    </div>
                `;
                list.appendChild(item);
            });
            refreshIcons();
        }

        /**
         * 5. POMODORO ENGINE
         */
        function toggleTimer() {
            if(!isHost) return;
            const btn = document.getElementById('pomo-action-btn');
            
            if(timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                btn.innerHTML = '<i data-lucide="play" class="w-5 h-5 fill-current"></i>';
            } else {
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    if(timerSeconds <= 0) {
                        handleTimerEnd();
                    }
                    updateTimerUI();
                    broadcast({ type: 'pomo-sync', timer: timerSeconds, mode: currentMode });
                    
                    if(currentMode === 'study' && timerSeconds % 60 === 0) {
                        totalFocusMinutes++;
                        document.getElementById('total-study-time').innerText = totalFocusMinutes + "P";
                    }
                }, 1000);
                btn.innerHTML = '<i data-lucide="pause" class="w-5 h-5 fill-current"></i>';
            }
            refreshIcons();
        }

        function handleTimerEnd() {
            document.getElementById('snd-alert').play();
            if(currentMode === 'study') {
                currentMode = 'break';
                timerSeconds = parseInt(document.getElementById('cfg-break').value) * 60;
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                appendMessage("H·ªá th·ªëng", "üéâ ƒê√£ ƒë·∫øn gi·ªù ngh·ªâ ng∆°i! H√£y v∆∞∆°n vai m·ªôt ch√∫t.");
            } else {
                currentMode = 'study';
                timerSeconds = parseInt(document.getElementById('cfg-study').value) * 60;
                appendMessage("H·ªá th·ªëng", "üìö Quay l·∫°i h·ªçc th√¥i n√†o c√°c b·∫°n ∆°i!");
            }
        }

        function updateTimerUI() {
            const m = Math.floor(timerSeconds / 60);
            const s = timerSeconds % 60;
            const timeStr = `${m}:${s < 10 ? '0' : ''}${s}`;
            document.getElementById('pomo-time').innerText = timeStr;
            
            const label = document.getElementById('pomo-label');
            const container = document.getElementById('pomo-timer-container');
            
            if(currentMode === 'study') {
                label.innerText = "H·ªåC T·∫¨P";
                label.className = "text-[8px] font-black tracking-widest uppercase text-sky-400";
                container.classList.remove('pomo-pulse');
            } else {
                label.innerText = "NGH·ªà GI·∫¢I LAO";
                label.className = "text-[8px] font-black tracking-widest uppercase text-green-400";
                container.classList.add('pomo-pulse');
            }
        }

        function syncTimerToAll() {
            if(!isHost) return;
            const studyVal = parseInt(document.getElementById('cfg-study').value);
            timerSeconds = studyVal * 60;
            currentMode = 'study';
            updateTimerUI();
            broadcast({ type: 'pomo-sync', timer: timerSeconds, mode: currentMode });
        }

        /**
         * 6. WHITEBOARD ENGINE (N√ÇNG C·∫§P)
         */
        
        // Load l·∫°i ·∫£nh c≈© t·ª´ localStorage n·∫øu c√≥
        function loadWB() {
            const data = localStorage.getItem('wb_data');
            if(data) {
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = data;
            }
        }

        function openWhiteboard() { 
            document.getElementById('whiteboard-container').style.display = 'flex';
            // Kh√¥ng reset canvas width/height ·ªü ƒë√¢y n·ªØa ƒë·ªÉ gi·ªØ n·ªôi dung
            // Load l·∫°i n·∫øu c·∫ßn thi·∫øt
            loadWB();
        }
        
        function closeWhiteboard() { 
            // L∆∞u l·∫°i ·∫£nh v√†o localStorage ƒë·ªÉ kh√¥ng b·ªã m·∫•t
            localStorage.setItem('wb_data', canvas.toDataURL());
            document.getElementById('whiteboard-container').style.display = 'none'; 
        }

        function setPenColor(color) { penColor = color; setTool('draw'); }
        function setTool(tool) {
            currentTool = tool;
            if(tool === 'text') {
                document.getElementById('tool-text-btn').classList.replace('bg-slate-700', 'bg-indigo-600');
                document.getElementById('tool-draw-btn').classList.replace('bg-indigo-600', 'bg-slate-700');
                canvas.style.cursor = 'text';
            } else {
                document.getElementById('tool-draw-btn').classList.replace('bg-slate-700', 'bg-indigo-600');
                document.getElementById('tool-text-btn').classList.replace('bg-indigo-600', 'bg-slate-700');
                canvas.style.cursor = 'crosshair';
            }
        }

        // S·ª± ki·ªán chu·ªôt tr√™n Canvas
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            // T√≠nh to√°n t·ªça ƒë·ªô ch√≠nh x√°c k·ªÉ c·∫£ khi ƒë√£ scroll
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            if (currentTool === 'text') {
                popupClickPos = {x, y};
                const popup = document.getElementById('math-input-popup');
                popup.style.display = 'flex';
                popup.style.left = e.clientX + 'px';
                popup.style.top = e.clientY + 'px';
                // ƒêi·ªÅu ch·ªânh n·∫øu popup b·ªã tr√†n m√†n h√¨nh
                if(e.clientY + 200 > window.innerHeight) popup.style.top = (e.clientY - 200) + 'px';
                document.getElementById('math-text-input').focus();
            } else {
                isDrawing = true;
                drawOnCanvas(x, y, penColor, penSize, true, myId);
                broadcast({ type: 'draw', x, y, color: penColor, size: penSize, isNewPath: true });
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            if(!isDrawing || currentTool !== 'draw') return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;

            drawOnCanvas(x, y, penColor, penSize, false, myId);
            broadcast({ type: 'draw', x, y, color: penColor, size: penSize, isNewPath: false });
        });

        canvas.addEventListener('mouseup', () => { 
            isDrawing = false; 
            localStorage.setItem('wb_data', canvas.toDataURL()); // Auto save khi th·∫£ chu·ªôt
        });

        // H√†m v·∫Ω ƒë∆∞·ª£c t·ªëi ∆∞u cho nhi·ªÅu ng∆∞·ªùi d√πng (tr√°nh lo·∫°n n√©t)
        function drawOnCanvas(x, y, color, size, isNewPath, userId) {
            ctx.lineWidth = size;
            ctx.lineCap = 'round';
            ctx.strokeStyle = color;

            // N·∫øu user n√†y ch∆∞a c√≥ v·ªã tr√≠ c≈©, ho·∫∑c l√† n√©t m·ªõi -> StartPath
            if (isNewPath || !lastPositions[userId]) {
                ctx.beginPath();
                ctx.moveTo(x, y);
            } else {
                // Ti·∫øp t·ª•c t·ª´ v·ªã tr√≠ cu·ªëi c√πng c·ªßa user ƒë√≥
                ctx.beginPath();
                ctx.moveTo(lastPositions[userId].x, lastPositions[userId].y);
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            // C·∫≠p nh·∫≠t v·ªã tr√≠ cu·ªëi c√πng cho user n√†y
            lastPositions[userId] = { x, y };
        }

        function clearWhiteboard() { 
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            localStorage.removeItem('wb_data');
            broadcast({ type: 'clear-wb' }); 
        }

        // --- X·ª¨ L√ù TEXT & MATH ---
        function closeMathPopup() {
            document.getElementById('math-input-popup').style.display = 'none';
            document.getElementById('math-text-input').value = '';
        }

        async function insertMathToCanvas() {
            const input = document.getElementById('math-text-input').value;
            if(!input) return;

            const x = popupClickPos.x;
            const y = popupClickPos.y;

            // S·ª≠ d·ª•ng MathJax ƒë·ªÉ chuy·ªÉn text/latex th√†nh SVG
            const wrapper = document.createElement('div');
            // C·∫•u h√¨nh options render
            const options = MathJax.getMetricsFor(document.body);
            
            try {
                // Render ra SVG Node
                const svg = await MathJax.tex2svgPromise(input, options);
                const svgElement = svg.querySelector('svg');
                
                // ƒê·∫∑t m√†u ch·ªØ (stroke/fill)
                svgElement.setAttribute('fill', penColor);
                svgElement.setAttribute('color', penColor);
                
                // Chuy·ªÉn SVG th√†nh XML string
                const s = new XMLSerializer().serializeToString(svgElement);
                // T·∫°o ·∫£nh Base64 t·ª´ SVG
                const imgSrc = 'data:image/svg+xml;base64,' + window.btoa(unescape(encodeURIComponent(s)));

                const img = new Image();
                img.onload = function() {
                    // V·∫Ω ·∫£nh l√™n canvas
                    ctx.drawImage(img, x, y);
                    // Broadcast cho ng∆∞·ªùi kh√°c
                    broadcast({ type: 'draw-image', src: imgSrc, x: x, y: y });
                    localStorage.setItem('wb_data', canvas.toDataURL());
                };
                img.src = imgSrc;

            } catch (err) {
                console.error("MathJax error:", err);
                // Fallback: V·∫Ω text th∆∞·ªùng n·∫øu l·ªói
                ctx.font = "20px 'Plus Jakarta Sans'";
                ctx.fillStyle = penColor;
                ctx.fillText(input, x, y);
            }

            closeMathPopup();
        }

        /**
         * 7. TO-DO LIST
         */
        function addNewTodo() {
            const input = document.getElementById('todo-input');
            if(!input.value) return;
            
            const newTodo = {
                id: Date.now(),
                text: input.value,
                done: false,
                by: myUserName
            };
            
            todos.push(newTodo);
            input.value = '';
            renderTodos();
            broadcast({ type: 'todo-update', todos: todos });
        }

        function toggleTodo(id) {
            todos = todos.map(t => t.id === id ? {...t, done: !t.done} : t);
            renderTodos();
            broadcast({ type: 'todo-update', todos: todos });
        }

        function renderTodos() {
            const list = document.getElementById('todo-list');
            list.innerHTML = '';
            let doneCount = 0;

            todos.forEach(t => {
                if(t.done) doneCount++;
                const item = document.createElement('div');
                item.className = `flex items-center gap-3 p-3 rounded-xl border transition-all ${t.done ? 'bg-green-500/10 border-green-500/20' : 'bg-white/5 border-white/5'}`;
                item.innerHTML = `
                    <button onclick="toggleTodo(${t.id})" class="w-5 h-5 rounded border-2 flex items-center justify-center ${t.done ? 'bg-green-500 border-green-500' : 'border-slate-600'}">
                        ${t.done ? '<i data-lucide="check" class="w-3 h-3 text-white"></i>' : ''}
                    </button>
                    <div class="flex flex-col flex-1">
                        <span class="text-sm ${t.done ? 'line-through text-slate-500' : 'text-slate-200'}">${t.text}</span>
                        <span class="text-[8px] text-slate-600 uppercase font-bold">Th√™m b·ªüi: ${t.by}</span>
                    </div>
                `;
                list.appendChild(item);
            });
            
            document.getElementById('todo-stats').innerText = `${doneCount}/${todos.length}`;
            refreshIcons();
        }

        /**
         * 8. MEDIA CONTROLS
         */
        function handleMicToggle() {
            const track = myStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            
            const btn = document.getElementById('mic-btn');
            const icon = document.getElementById('mic-icon');
            
            btn.classList.toggle('bg-red-500', !track.enabled);
            btn.classList.toggle('bg-slate-800', track.enabled);
            icon.setAttribute('data-lucide', track.enabled ? 'mic' : 'mic-off');
            
            updateParticipantStatus(myId, track.enabled, myStream.getVideoTracks()[0].enabled);
            broadcast({ type: 'mic-cam-status', mic: track.enabled, cam: myStream.getVideoTracks()[0].enabled });
            refreshIcons();
        }

        function handleCamToggle() {
            const track = myStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            
            const btn = document.getElementById('cam-btn');
            const icon = document.getElementById('cam-icon');
            
            btn.classList.toggle('bg-red-500', !track.enabled);
            btn.classList.toggle('bg-slate-800', track.enabled);
            icon.setAttribute('data-lucide', track.enabled ? 'video' : 'video-off');
            
            updateParticipantStatus(myId, myStream.getAudioTracks()[0].enabled, track.enabled);
            broadcast({ type: 'mic-cam-status', mic: myStream.getAudioTracks()[0].enabled, cam: track.enabled });
            refreshIcons();
        }

        async function handleScreenShare() {
            if(myScreenStream) {
                myScreenStream.getTracks().forEach(t => t.stop());
                myScreenStream = null;
                replaceStreamInCalls(myStream);
                document.getElementById('local-video').srcObject = myStream;
                document.getElementById('screen-btn').classList.remove('bg-sky-600', 'text-white');
                return;
            }

            try {
                myScreenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                document.getElementById('local-video').srcObject = myScreenStream;
                document.getElementById('screen-btn').classList.add('bg-sky-600', 'text-white');
                
                replaceStreamInCalls(myScreenStream);

                myScreenStream.getVideoTracks()[0].onended = () => {
                    handleScreenShare();
                };
            } catch (err) {
                console.error("Screen share error:", err);
            }
        }

        function replaceStreamInCalls(newStream) {
            Object.values(peerConnections).forEach(call => {
                const videoTrack = newStream.getVideoTracks()[0];
                const sender = call.peerConnection.getSenders().find(s => s.track.kind === 'video');
                if(sender) sender.replaceTrack(videoTrack);
            });
        }

        /**
         * 9. √ÇM THANH TI·∫æNG M∆ØA
         */
        let isRainPlaying = false;
        function toggleRainSound() {
            const snd = document.getElementById('snd-rain');
            const btn = document.getElementById('rain-toggle');
            isRainPlaying = !isRainPlaying;
            
            if(isRainPlaying) {
                snd.play();
                btn.classList.add('text-sky-400');
            } else {
                snd.pause();
                btn.classList.remove('text-sky-400');
            }
        }
        document.getElementById('rain-vol').oninput = (e) => {
            document.getElementById('snd-rain').volume = e.target.value;
        };

        /**
         * 10. CHAT & AI
         */
        document.getElementById('chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if(!val) return;
            
            // X·ª≠ l√Ω AI command
            if (val.toLowerCase().startsWith('/ai')) {
                appendMessage('B·∫°n', val); // Hi·ªán tin nh·∫Øn g·ªëc
                const query = val.substring(3).trim();
                if(!query) {
                    appendMessage(bot.name, bot.getRandom(bot.greetings), true);
                } else {
                    // Gi·∫£ l·∫≠p AI suy nghƒ© m·ªôt ch√∫t
                    setTimeout(() => {
                        const reply = bot.process(query);
                        appendMessage(bot.name, reply, true);
                    }, 500);
                }
            } else {
                // Chat b√¨nh th∆∞·ªùng
                appendMessage('B·∫°n', val);
                broadcast({ type: 'chat', user: myUserName, msg: val });
            }

            input.value = '';
            resetAIIdleTimer();
        };

        function appendMessage(user, msg, isAI = false) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = "flex flex-col gap-1 fade-in";
            
            const colorClass = isAI ? "text-sky-400" : (user === 'B·∫°n' ? "text-yellow-500" : "text-slate-500");
            const bgClass = isAI ? "bg-sky-500/10 border-sky-500/20" : "bg-slate-800 border-white/5";

            div.innerHTML = `
                <span class="text-[10px] font-bold uppercase ml-2 ${colorClass}">${user}</span>
                <div class="${bgClass} p-3 rounded-2xl border text-sm">
                    ${msg}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            if(activeTab !== 'chat') {
                document.getElementById('chat-notif').classList.remove('hidden');
            }
        }

        function switchTab(tab) {
            activeTab = tab;
            ['chat', 'todo', 'users'].forEach(t => {
                document.getElementById(`tab-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}-btn`).classList.remove('border-sky-500', 'bg-sky-500/5', 'text-sky-400');
                document.getElementById(`tab-${t}-btn`).classList.add('border-transparent', 'text-slate-500');
            });
            
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}-btn`).classList.add('border-sky-500', 'bg-sky-500/5', 'text-sky-400');
            document.getElementById(`tab-${tab}-btn`).classList.remove('border-transparent', 'text-slate-500');
            
            if(tab === 'chat') document.getElementById('chat-notif').classList.add('hidden');
        }

        function toggleSidebar(defaultTab) {
            const sidebar = document.getElementById('main-sidebar');
            if(sidebar.style.display === 'none') {
                sidebar.style.display = 'flex';
                if(defaultTab) switchTab(defaultTab);
            } else {
                sidebar.style.display = 'none';
            }
        }

        function handleLeaveRoom() {
            if(confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi ph√≤ng h·ªçc?")) {
                location.reload();
            }
        }

        function refreshIcons() {
            lucide.createIcons();
        }

        // Kh·ªüi t·∫°o c√°c th√†nh ph·∫ßn UI ban ƒë·∫ßu
        updateTimerUI();
    </script>
</body>
</html>
